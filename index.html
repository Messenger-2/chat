<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Messenger</title>
  <style>
    :root{--bg:#0f1724;--panel:#0b1220;--muted:#9aa4b2;--primary:#7c5cff;--accent:#22c1c3;--bubble-in:#0b1220;--bubble-out:#122033;--text:#e6eef6;--glass: rgba(255,255,255,0.03);}    
    [data-theme="light"]{--bg:#f5f7fb;--panel:#ffffff;--muted:#6b7280;--primary:#5b21b6;--accent:#0ea5a4;--bubble-in:#f3f4f6;--bubble-out:#e6eef6;--text:#0b1220;--glass: rgba(11,18,32,0.04);}    
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;}
    body{background:linear-gradient(180deg,var(--bg),#071021);color:var(--text);display:grid;place-items:center;padding:28px}
    .app{width:100%;max-width:1200px;height:86vh;background:linear-gradient(180deg,var(--panel),rgba(0,0,0,0.06));border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6);display:grid;grid-template-columns:320px 1fr;overflow:hidden}
    .sidebar{padding:22px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);backdrop-filter: blur(6px);}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;font-weight:700}
    .brand h1{font-size:16px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .login-card{margin-top:8px;background:var(--glass);padding:14px;border-radius:12px}
    .field{margin-bottom:10px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text);outline:none}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--primary),var(--accent));color:white;border:none;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.danger{background:linear-gradient(90deg,#dc2626,#ef4444)}
    .small{font-size:13px}
    .prefs{margin-top:14px;display:flex;gap:10px;align-items:center}
    .toggle{cursor:pointer;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .messenger{display:flex;flex-direction:column;height:100%}
    .header{padding:18px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between}
    .who{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;font-weight:700}
    .header h2{margin:0}
    .messages{flex:1;overflow:auto;padding:22px;display:flex;flex-direction:column;gap:12px;background-image:linear-gradient(180deg,transparent, rgba(255,255,255,0.01));}
    .msg{max-width:72%;padding:10px 12px;border-radius:12px;background:var(--bubble-out);align-self:flex-start}
    .msg.me{background:linear-gradient(180deg,var(--primary),var(--accent));color:white;align-self:flex-end}
    .msg.pinned{box-shadow:0 6px 20px rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.03)}
    .meta{font-size:11px;color:var(--muted);margin-top:6px}
    .controls-below{display:flex;gap:6px;margin-top:8px}
    .composer{padding:12px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:10px;align-items:center}
    .composer input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
    .info{padding:12px;color:var(--muted);font-size:13px}
    .admin-panel{padding:12px;background:rgba(0,0,0,0.06);border-top:1px solid rgba(255,255,255,0.02)}
    .log-list{max-height:240px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .log-item{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px}
    .row{display:flex;gap:8px;align-items:center}
    .chip{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03)}
    .danger-zone{margin-top:20px;padding:16px;border:1px solid rgba(220,38,38,0.3);border-radius:12px;background:rgba(220,38,38,0.05)}
    .danger-zone h3{color:#dc2626;margin:0 0 12px 0;font-size:16px}
    @media (max-width:800px){.app{grid-template-columns:1fr}.sidebar{display:none}}
  </style>
</head>
<body>
  <div class="app" role="application">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">M</div>
        <div>
          <h1>Messenger</h1>
          <div class="muted">Sichere Kommunikation</div>
        </div>
      </div>
      <div class="login-card" id="loginCard">
        <div class="field">
          <label for="name">Name</label>
          <input id="name" autocomplete="off" />
        </div>
        <div class="field">
          <label for="password">Passwort</label>
          <input id="password" type="password" autocomplete="off" />
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn" id="loginBtn">Anmelden</button>
        </div>
        <div class="prefs">
          <div style="font-size:13px;color:var(--muted)">Design</div>
          <button class="toggle" id="themeBtn">Dark / Light</button>
        </div>
        <div class="info" style="margin-top:12px">
          <div class="muted small">Admin Login: ADMIN / lucwag22,10</div>
        </div>
      </div>
    </aside>
    <main class="messenger">
      <div class="header">
        <div class="who">
          <div class="avatar" id="avatar">?</div>
          <div>
            <h2 id="displayName">Nicht angemeldet</h2>
            <div class="muted" id="status">Bitte melde dich an, um zu chatten.</div>
          </div>
        </div>
        <div>
          <button class="btn" id="adminToggleBtn" style="display:none">Admin Ansicht √∂ffnen</button>
          <button class="btn" id="logoutBtn" style="display:none">Abmelden</button>
        </div>
      </div>
      <div class="messages" id="messages">
        <div class="muted info">Noch keine Nachrichten.</div>
      </div>
      <div class="composer">
        <input id="messageInput" placeholder="Schreibe eine Nachricht..." disabled />
        <button class="btn" id="sendBtn" disabled>Senden</button>
      </div>
      <div class="admin-panel" id="adminPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="row"><strong>Admin-Logs</strong><div class="muted" style="margin-left:8px;font-size:13px">(IP-Adressen sind simuliert)</div></div>
          <div class="row"><button class="btn" id="closeAdmin">Admin Ansicht schlie√üen</button></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:12px">
          <div style="flex:1">
            <div class="muted" style="margin-bottom:6px">Letzte Logs</div>
            <div class="log-list" id="logList"></div>
            <div style="margin-top:8px"><button class="btn" id="emergencyClean">Emergency Clean (Chat leeren, Logs behalten)</button></div>
          </div>
          <div style="width:320px">
            <div class="muted" style="margin-bottom:6px">Live-√úbersicht</div>
            <div id="liveUsers" class="log-list"></div>
            <div style="margin-top:10px">
              <div class="muted">Banned IPs</div>
              <div id="bannedList" class="log-list"></div>
            </div>
          </div>
        </div>
        
        <!-- Danger Zone -->
        <div class="danger-zone">
          <h3>‚ö†Ô∏è Danger Zone</h3>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <button class="btn danger" id="cleanAllBtn">ALLES L√ñSCHEN</button>
            <div class="muted small" style="flex:1">
              L√∂scht komplett alles: Nachrichten, Accounts, Logs, Einstellungen. Kann nicht r√ºckg√§ngig gemacht werden!
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    // --- Einstellungen / Elemente ---
    const nameInput=document.getElementById('name');
    const passInput=document.getElementById('password');
    const loginBtn=document.getElementById('loginBtn');
    const themeBtn=document.getElementById('themeBtn');
    const displayName=document.getElementById('displayName');
    const avatar=document.getElementById('avatar');
    const status=document.getElementById('status');
    const logoutBtn=document.getElementById('logoutBtn');
    const adminToggleBtn=document.getElementById('adminToggleBtn');
    const adminPanel=document.getElementById('adminPanel');
    const closeAdmin=document.getElementById('closeAdmin');
    const messagesEl=document.getElementById('messages');
    const msgInput=document.getElementById('messageInput');
    const sendBtn=document.getElementById('sendBtn');
    const logList=document.getElementById('logList');
    const liveUsers=document.getElementById('liveUsers');
    const bannedList=document.getElementById('bannedList');
    const cleanAllBtn=document.getElementById('cleanAllBtn');

    // --- Admin credentials ---
    const ADMIN_USERNAME = 'ADMIN';
    const ADMIN_PASSWORD = 'lucwag22,10';

    // --- Storage keys ---
    const KEY_MESSAGES = 'mm_messages';
    const KEY_ACTIVE = 'mm_active_users'; // array of names
    const KEY_META = 'mm_user_meta'; // map name -> {ip,loginAt}
    const KEY_BANNED = 'mm_banned_ips'; // array of {ip,reason,expires}
    const KEY_LOGS = 'mm_logs'; // all events (send/delete/clean)
    const KEY_ARCHIVE = 'mm_archive'; // emergency archive of messages

    // Theme
    const savedTheme=localStorage.getItem('mm_theme')||'dark';
    document.documentElement.setAttribute('data-theme',savedTheme==='light'?'light':'dark');
    themeBtn.addEventListener('click',()=>{const cur=document.documentElement.getAttribute('data-theme')==='light'?'light':'dark';const next=cur==='light'?'dark':'light';document.documentElement.setAttribute('data-theme',next);localStorage.setItem('mm_theme',next);});

    // --- Helpers ---
    function now(){return new Date().toISOString();}
    function uid(n){return n.trim();}
    function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
    function genIp(){return `192.168.${randInt(0,255)}.${randInt(1,254)}`;} // simuliert
    function load(key){const r=localStorage.getItem(key);return r?JSON.parse(r):null;}
    function save(key,val){localStorage.setItem(key,JSON.stringify(val));}

    // ensure keys
    function ensure(){ if(!localStorage.getItem(KEY_MESSAGES)) save(KEY_MESSAGES,[]); if(!localStorage.getItem(KEY_ACTIVE)) save(KEY_ACTIVE,[]); if(!localStorage.getItem(KEY_META)) save(KEY_META,{}); if(!localStorage.getItem(KEY_BANNED)) save(KEY_BANNED,[]); if(!localStorage.getItem(KEY_LOGS)) save(KEY_LOGS,[]); if(!localStorage.getItem(KEY_ARCHIVE)) save(KEY_ARCHIVE,[]); }

    function loadMessages(){return load(KEY_MESSAGES) || []}
    function saveMessages(list){save(KEY_MESSAGES,list)}
    function loadLogs(){return load(KEY_LOGS) || []}
    function pushLog(entry){ const logs = loadLogs(); logs.push(entry); save(KEY_LOGS,logs); }
    function loadActive(){return load(KEY_ACTIVE)||[]} 
    function saveActive(list){save(KEY_ACTIVE,list)}
    function loadMeta(){return load(KEY_META)||{}}
    function saveMeta(m){save(KEY_META,m)}
    function loadBanned(){return load(KEY_BANNED)||[]}
    function saveBanned(list){save(KEY_BANNED,list)}
    function loadArchive(){return load(KEY_ARCHIVE)||[]}
    function saveArchive(a){save(KEY_ARCHIVE,a)}

    function isBanned(ip){
      const bans = loadBanned();
      const nowTs = Date.now();
      return bans.some(b=>b.ip===ip && (!b.expires || new Date(b.expires).getTime()>nowTs));
    }

    // render chat messages (controls moved below message)
    function renderMessages(){
      const list = loadMessages();
      messagesEl.innerHTML = '';
      if(!list.length){ messagesEl.innerHTML = '<div class="muted info">Noch keine Nachrichten.</div>'; return; }
      const cur = sessionStorage.getItem('mm_current');
      list.forEach((m, idx)=>{
        const div = document.createElement('div');
        div.className = 'msg' + (m.pinned ? ' pinned' : '') + (m.sender === cur ? ' me' : '');
        const content = document.createElement('div');
        content.innerHTML = `<div>${escapeHtml(m.text)}</div><div class="meta">${escapeHtml(m.sender)} ‚Ä¢ ${new Date(m.time).toLocaleString()} ‚Ä¢ IP: ${escapeHtml(m.ip||'‚Äî')}</div>`;
        div.appendChild(content);

        // controls BELOW the message
        if(sessionStorage.getItem('mm_is_admin')==='1'){
          const ctrl = document.createElement('div'); ctrl.className='controls-below';
          const pin = document.createElement('button'); pin.className='toggle small'; pin.textContent=m.pinned?'Entpinnen':'Pin'; pin.onclick=()=>{togglePin(idx)};
          const del = document.createElement('button'); del.className='toggle small'; del.textContent='L√∂schen'; del.onclick=()=>{deleteMessage(idx)};
          const banip = document.createElement('button'); banip.className='toggle small'; banip.textContent='Ban IP'; banip.onclick=()=>{banIp(m.ip)};
          const timeout = document.createElement('button'); timeout.className='toggle small'; timeout.textContent='Timeout 1min'; timeout.onclick=()=>{timeoutUser(m.sender,60)};
          ctrl.appendChild(pin); ctrl.appendChild(del); ctrl.appendChild(banip); ctrl.appendChild(timeout);
          div.appendChild(ctrl);
        }

        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function escapeHtml(s){return String(s).replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]||c));}

    // --- Login flow ---
    loginBtn.addEventListener('click',()=>{
      const name = uid(nameInput.value);
      const pass = (passInput.value||'');
      if(!name){ alert('Bitte Namen eingeben'); return; }

      // Admin login - erlaubt immer, auch wenn bereits angemeldet
      if(name.toUpperCase()===ADMIN_USERNAME && pass===ADMIN_PASSWORD){
        sessionStorage.setItem('mm_current',ADMIN_USERNAME);
        sessionStorage.setItem('mm_is_admin','1');
        const meta = loadMeta(); meta[ADMIN_USERNAME] = { ip: genIp(), loginAt: now() }; saveMeta(meta);
        
        // Admin wird nicht in aktive Benutzerliste aufgenommen
        const active = loadActive();
        if(!active.includes(ADMIN_USERNAME)) {
          active.push(ADMIN_USERNAME);
          saveActive(active);
        }
        
        onLogin(ADMIN_USERNAME,true);
        return;
      }

      // prevent duplicate display names: check active users (nur f√ºr normale Benutzer)
      const active = loadActive();
      if(active.includes(name)){
        alert('Dieser Name ist bereits angemeldet. W√§hle bitte einen anderen Namen.');
        return;
      }

      sessionStorage.setItem('mm_current',name);
      sessionStorage.setItem('mm_is_admin','0');
      const meta = loadMeta();
      meta[name] = { ip: genIp(), loginAt: now() }; saveMeta(meta);
      active.push(name); saveActive(active);
      onLogin(name,false);
    });

    logoutBtn.addEventListener('click',()=>{
      const cur = sessionStorage.getItem('mm_current');
      if(cur){
        const active = loadActive().filter(n=>n!==cur);
        saveActive(active);
      }
      sessionStorage.removeItem('mm_current');
      sessionStorage.removeItem('mm_is_admin');
      updateUIForAnonymous();
    });

    // send message
    sendBtn.addEventListener('click',sendMessage);
    msgInput.addEventListener('keydown',e=>{ if(e.key==='Enter') sendMessage(); });

    function sendMessage(){
      const txt = msgInput.value.trim(); if(!txt) return;
      const sender = sessionStorage.getItem('mm_current'); if(!sender) return;
      const meta = loadMeta(); const ip = meta[sender] ? meta[sender].ip : genIp();
      if(isBanned(ip)){ alert('Deine IP ist gebannt ‚Äî du kannst keine Nachrichten senden.'); return; }
      const timeouts = load('mm_timeouts') || {};
      if(timeouts[sender] && new Date(timeouts[sender]).getTime() > Date.now()){ alert('Du bist tempor√§r gesperrt.'); return; }
      const msgs = loadMessages(); const entry = { sender, text: txt, time: now(), ip, pinned:false };
      msgs.push(entry); saveMessages(msgs);
      // append to logs (will keep even if message is later removed)
      pushLog(Object.assign({ event:'sent' }, entry));
      msgInput.value=''; renderMessages(); renderAdmin();
    }

    // admin functions (delete from chat, but keep logs)
    function deleteMessage(idx){
      const msgs = loadMessages();
      const removed = msgs.splice(idx,1);
      saveMessages(msgs);
      if(removed && removed[0]){
        pushLog({ event:'deleted', sender: removed[0].sender, text: removed[0].text, time: now(), ip: removed[0].ip });
      }
      renderMessages(); renderAdmin();
    }
    function togglePin(idx){ const msgs = loadMessages(); msgs[idx].pinned = !msgs[idx].pinned; saveMessages(msgs); pushLog({ event: 'pin_changed', index: idx, pinned: msgs[idx].pinned, time: now(), sender: msgs[idx].sender }); renderMessages(); renderAdmin(); }
    function banIp(ip){ if(!ip){ alert('Keine IP verf√ºgbar'); return;} const bans = loadBanned(); bans.push({ ip, reason: 'admin-ban', expires: null}); saveBanned(bans); pushLog({ event:'ban', ip, time: now() }); renderAdmin(); }
    function timeoutUser(name,seconds){ const timeouts = load('mm_timeouts')||{}; timeouts[name] = new Date(Date.now()+seconds*1000).toISOString(); save('mm_timeouts',timeouts); pushLog({ event:'timeout', name, seconds, time: now() }); renderAdmin(); }

    // emergency clean: clear chat messages but keep logs and archive messages
    function emergencyClean(){ const msgs = loadMessages(); if(!msgs.length){ alert('Keine Nachrichten zum Bereinigen.'); return;} const archive = loadArchive(); // move messages to archive
      msgs.forEach(m=>archive.push(m)); saveArchive(archive); saveMessages([]); pushLog({ event:'emergency_clean', count: msgs.length, time: now() }); renderMessages(); renderAdmin(); alert('Chat wurde geleert (Archiv in localStorage). Logs bleiben erhalten.'); }

    // COMPLETE CLEAN - l√∂scht ALLES
    function cleanAll(){
      // Erste Best√§tigung
      if(!confirm('‚ö†Ô∏è  ACHTUNG: ALLES wird gel√∂scht!\n\n‚Ä¢ Alle Nachrichten\n‚Ä¢ Alle Benutzerkonten\n‚Ä¢ Alle Logs\n‚Ä¢ Alle Einstellungen\n\nDiese Aktion kann NICHT r√ºckg√§ngig gemacht werden!\n\nFortfahren?')) {
        return;
      }
      
      // Zweite Best√§tigung
      if(!confirm('üö® LETZTE WARNUNG!\n\nWirklich ALLES l√∂schen?\n\nDanach ist alles weg - keine Wiederherstellung m√∂glich!')) {
        return;
      }
      
      // Alles l√∂schen
      localStorage.clear();
      sessionStorage.clear();
      
      // Log f√ºr letzte Aktion (falls gew√ºnscht)
      localStorage.setItem('mm_last_clean', now());
      
      alert('‚úÖ Alles wurde gel√∂scht! Die Seite wird neu geladen.');
      setTimeout(() => {
        location.reload();
      }, 1000);
    }

    // render admin panel: uses logs (preserved) and shows live users + bans
    function renderAdmin(){
      const logs = loadLogs().slice().reverse();
      logList.innerHTML='';
      logs.forEach((m,idx)=>{
        const div = document.createElement('div'); div.className='log-item';
        let title = '';
        if(m.event==='sent') title = `<div style="font-weight:600">${escapeHtml(m.sender)}</div><div style="font-size:13px">${escapeHtml(m.text)}</div><div class="muted" style="margin-top:6px;font-size:12px">${new Date(m.time).toLocaleString()} ‚Ä¢ IP: ${escapeHtml(m.ip||'‚Äî')}</div>`;
        else if(m.event==='deleted') title = `<div style="font-weight:600">(gel√∂scht) ${escapeHtml(m.sender)}</div><div style="font-size:13px">${escapeHtml(m.text)}</div><div class="muted" style="margin-top:6px;font-size:12px">${new Date(m.time).toLocaleString()} ‚Ä¢ IP: ${escapeHtml(m.ip||'‚Äî')}</div>`;
        else if(m.event==='ban') title = `<div style="font-weight:600">BANN</div><div class="muted" style="margin-top:6px;font-size:12px">IP: ${escapeHtml(m.ip)} ‚Ä¢ ${new Date(m.time).toLocaleString()}</div>`;
        else if(m.event==='timeout') title = `<div style="font-weight:600">TIMEOUT</div><div class="muted" style="margin-top:6px;font-size:12px">User: ${escapeHtml(m.name)} ‚Ä¢ ${new Date(m.time).toLocaleString()}</div>`;
        else if(m.event==='emergency_clean') title = `<div style="font-weight:600">EMERGENCY CLEAN</div><div class="muted" style="margin-top:6px;font-size:12px">Anzahl: ${m.count} ‚Ä¢ ${new Date(m.time).toLocaleString()}</div>`;
        else if(m.event==='pin_changed') title = `<div style="font-weight:600">PIN</div><div class="muted" style="margin-top:6px;font-size:12px">${escapeHtml(m.sender)} ‚Ä¢ pinned: ${m.pinned} ‚Ä¢ ${new Date(m.time).toLocaleString()}</div>`;
        else title = `<div style="font-weight:600">LOG</div><div class="muted" style="margin-top:6px;font-size:12px">${JSON.stringify(m)}</div>`;
        div.innerHTML = title;
        logList.appendChild(div);
      });

      // live users
      const active = loadActive();
      liveUsers.innerHTML = '';
      const meta = loadMeta();
      active.forEach(u=>{
        const d = meta[u]||{};
        const el = document.createElement('div'); el.className='log-item'; el.innerHTML = `<div style="font-weight:600">${escapeHtml(u)}</div><div class="muted">IP: ${escapeHtml(d.ip||'‚Äî')} ‚Ä¢ login: ${d.loginAt?new Date(d.loginAt).toLocaleString():'‚Äî'}</div><div style="margin-top:6px;display:flex;gap:6px"><button class="toggle small" onclick="window.__mm_ban('${(d.ip||'')}')">Ban IP</button><button class="toggle small" onclick="window.__mm_timeout('${escapeHtml(u)}',60)">Timeout 1min</button></div>`;
        liveUsers.appendChild(el);
      });

      // banned
      const bans = loadBanned(); bannedList.innerHTML='';
      bans.forEach(b=>{ const el = document.createElement('div'); el.className='log-item'; el.innerHTML = `<div style="font-weight:600">${escapeHtml(b.ip)}</div><div class="muted">${escapeHtml(b.reason||'')}${b.expires? (' ‚Ä¢ bis: '+ new Date(b.expires).toLocaleString()):''}</div><div style="margin-top:6px;display:flex;gap:6px"><button class="toggle small" onclick="window.__mm_unban('${b.ip}')">Unban</button></div>`; bannedList.appendChild(el); });
    }

    // expose some functions for inline onclicks
    window.__mm_ban = function(ip){ banIp(ip); }
    window.__mm_unban = function(ip){ const bans = loadBanned().filter(b=>b.ip!==ip); saveBanned(bans); renderAdmin(); }
    window.__mm_timeout = function(name,seconds){ timeoutUser(name,seconds); }

    // Admin toggle
    adminToggleBtn.addEventListener('click',()=>{ adminPanel.style.display='block'; renderAdmin(); });
    closeAdmin.addEventListener('click',()=>{ adminPanel.style.display='none'; });
    document.getElementById('emergencyClean').addEventListener('click',()=>{ if(confirm('Emergency Clean durchf√ºhren? Dies leert den Chat, Logs bleiben erhalten.')) emergencyClean(); });
    cleanAllBtn.addEventListener('click', cleanAll);

    function onLogin(name,isAdmin){
      displayName.textContent=name; avatar.textContent=(name[0]||'?').toUpperCase(); status.textContent=isAdmin? 'Admin' : 'Online'; logoutBtn.style.display='inline-flex'; msgInput.disabled=false; sendBtn.disabled=false; if(isAdmin){ adminToggleBtn.style.display='inline-flex'; } else { adminToggleBtn.style.display='none'; }
      renderMessages(); renderAdmin();
    }

    function updateUIForAnonymous(){ displayName.textContent='Nicht angemeldet'; avatar.textContent='?'; status.textContent='Bitte melde dich an, um zu chatten.'; logoutBtn.style.display='none'; adminToggleBtn.style.display='none'; msgInput.disabled=true; sendBtn.disabled=true; renderMessages(); }

    // init
    (function(){
      ensure();
      // load messages and admin UI
      const cur = sessionStorage.getItem('mm_current');
      if(cur){ const isAdmin = sessionStorage.getItem('mm_is_admin')==='1'; onLogin(cur,isAdmin); }
      else updateUIForAnonymous();
    })();

  </script>
</body>
</html>
